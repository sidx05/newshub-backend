#!/usr/bin/env node
import fs from 'fs/promises';
import path from 'path';
import { fileURLToPath } from 'url';
// åŠ¨æ€å¯¼å…¥ ZAIï¼Œæ”¯æŒå…¨å±€å®‰è£…
async function getZAI() {
    try {
        // å°è¯•ä»åŒ…åå¯¼å…¥ï¼ˆå…¨å±€å®‰è£…æ—¶ï¼‰
        const packageName = 'z-ai-web-dev-sdk';
        const { default: ZAI } = await import(packageName);
        return ZAI;
    }
    catch (error1) {
        try {
            // å°è¯•ä»å…¨å±€node_modulesç›´æ¥å¯¼å…¥ï¼ˆå®¹å™¨ç¯å¢ƒä¿®å¤ï¼‰
            const globalPackagePath = '/usr/lib/node_modules/z-ai-web-dev-sdk/dist/index.js';
            const { default: ZAI } = await import(globalPackagePath);
            return ZAI;
        }
        catch (error2) {
            try {
                // åŠ¨æ€è·å–å…¨å±€è·¯å¾„
                const { execSync } = await import('child_process');
                const globalRoot = execSync('npm root -g').toString().trim();
                const globalPackagePath = path.join(globalRoot, 'z-ai-web-dev-sdk', 'dist', 'index.js');
                const { default: ZAI } = await import(globalPackagePath);
                return ZAI;
            }
            catch (error3) {
                // æœ€åå›é€€åˆ°ç›¸å¯¹è·¯å¾„å¯¼å…¥ï¼ˆå¼€å‘æ—¶ï¼‰
                const __filename = fileURLToPath(import.meta.url);
                const __dirname = path.dirname(__filename);
                const indexPath = path.resolve(__dirname, './index.js');
                const { default: ZAI } = await import(indexPath);
                return ZAI;
            }
        }
    }
}
function showHelp() {
    console.log(`
Z-AI SDK CLI - å›¾ç‰‡ç”Ÿæˆå·¥å…·

ç”¨æ³•:
  z-ai-generate [é€‰é¡¹]

é€‰é¡¹:
  --prompt, -p <æ–‡æœ¬>     å¿…éœ€ï¼šå›¾ç‰‡æè¿°æ–‡æœ¬
  --output, -o <è·¯å¾„>     å¿…éœ€ï¼šè¾“å‡ºå›¾ç‰‡æ–‡ä»¶è·¯å¾„(png æ ¼å¼)
  --model, -m <æ¨¡å‹>      å¯é€‰ï¼šæ¨¡å‹ä»£ç  (é»˜è®¤: cogview-4-250304)
  --size, -s <å°ºå¯¸>       å¯é€‰ï¼šå›¾ç‰‡å°ºå¯¸ (é»˜è®¤: 1024x1024)
                         æ”¯æŒçš„å°ºå¯¸: 1024x1024, 768x1344, 864x1152, 
                                   1344x768, 1152x864, 1440x720, 720x1440
  --help, -h             æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯

ç¤ºä¾‹:
  z-ai-generate --prompt "ä¸€åªå¯çˆ±çš„å°çŒ«" --output "./cat.png"
  z-ai-generate -p "ç¾ä¸½çš„é£æ™¯" -o "./landscape.jpg" -q hd -s 1344x768

æ³¨æ„ï¼š
  - éœ€è¦åœ¨é¡¹ç›®ç›®å½•ã€ç”¨æˆ·ä¸»ç›®å½•æˆ– /etc ä¸‹åˆ›å»º .z-ai-config é…ç½®æ–‡ä»¶
  - é…ç½®æ–‡ä»¶æ ¼å¼ï¼š{"baseUrl": "your-api-url", "apiKey": "your-api-key"}
`);
}
function parseArgs(args) {
    const options = {
        prompt: '',
        output: '',
        model: 'cogview-4-250304',
        // quality: 'standard',
        size: '1024x1024',
    };
    for (let i = 0; i < args.length; i++) {
        const arg = args[i];
        const nextArg = args[i + 1];
        switch (arg) {
            case '--prompt':
            case '-p':
                if (!nextArg) {
                    throw new Error('--prompt å‚æ•°ç¼ºå°‘å€¼');
                }
                options.prompt = nextArg;
                i++;
                break;
            case '--output':
            case '-o':
                if (!nextArg) {
                    throw new Error('--output å‚æ•°ç¼ºå°‘å€¼');
                }
                options.output = nextArg;
                i++;
                break;
            case '--model':
            case '-m':
                if (!nextArg) {
                    throw new Error('--model å‚æ•°ç¼ºå°‘å€¼');
                }
                options.model = nextArg;
                i++;
                break;
            // case '--quality':
            // case '-q':
            //   if (!nextArg) {
            //     throw new Error('--quality å‚æ•°ç¼ºå°‘å€¼');
            //   }
            //   if (nextArg !== 'standard' && nextArg !== 'hd') {
            //     throw new Error('--quality å¿…é¡»æ˜¯ standard æˆ– hd');
            //   }
            //   options.quality = nextArg as 'standard' | 'hd';
            //   i++;
            //   break;
            case '--size':
            case '-s':
                if (!nextArg) {
                    throw new Error('--size å‚æ•°ç¼ºå°‘å€¼');
                }
                const validSizes = ['1024x1024', '768x1344', '864x1152', '1344x768', '1152x864', '1440x720', '720x1440'];
                if (!validSizes.includes(nextArg)) {
                    throw new Error(`--size å¿…é¡»æ˜¯ä»¥ä¸‹å€¼ä¹‹ä¸€: ${validSizes.join(', ')}`);
                }
                options.size = nextArg;
                i++;
                break;
            case '--help':
            case '-h':
                options.help = true;
                break;
            default:
                if (arg.startsWith('-')) {
                    throw new Error(`æœªçŸ¥å‚æ•°: ${arg}`);
                }
                break;
        }
    }
    return options;
}
function base64ToBuffer(base64Data) {
    return Buffer.from(base64Data, 'base64');
}
async function saveImage(base64Data, outputPath) {
    try {
        const buffer = base64ToBuffer(base64Data);
        // ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
        const outputDir = path.dirname(outputPath);
        await fs.mkdir(outputDir, { recursive: true });
        // ä¿å­˜å›¾ç‰‡
        await fs.writeFile(outputPath, buffer);
        console.log(`âœ… å›¾ç‰‡å·²ä¿å­˜åˆ°: ${outputPath}`);
    }
    catch (error) {
        throw new Error(`ä¿å­˜å›¾ç‰‡å¤±è´¥: ${error}`);
    }
}
async function main() {
    try {
        const args = process.argv.slice(2);
        const options = parseArgs(args);
        if (options.help) {
            showHelp();
            return;
        }
        if (!options.prompt) {
            console.error('âŒ é”™è¯¯: ç¼ºå°‘å¿…éœ€å‚æ•° --prompt');
            showHelp();
            process.exit(1);
        }
        if (!options.output) {
            console.error('âŒ é”™è¯¯: ç¼ºå°‘å¿…éœ€å‚æ•° --output');
            showHelp();
            process.exit(1);
        }
        console.log('ğŸš€ æ­£åœ¨åˆå§‹åŒ– Z-AI SDK...');
        const ZAI = await getZAI();
        const client = await ZAI.create();
        console.log(`ğŸ¨ æ­£åœ¨ç”Ÿæˆå›¾ç‰‡: "${options.prompt}"`);
        // console.log(`ğŸ¯ è´¨é‡: ${options.quality}`);
        console.log(`ğŸ“ å°ºå¯¸: ${options.size}`);
        const response = await client.images.generations.create({
            model: options.model,
            prompt: options.prompt,
            // quality: options.quality,
            size: options.size,
        });
        if (!response.data || response.data.length === 0) {
            throw new Error('API æœªè¿”å›å›¾ç‰‡æ•°æ®');
        }
        const imageBase64 = response.data[0].base64;
        await saveImage(imageBase64, options.output);
        console.log('ğŸ‰ å›¾ç‰‡ç”Ÿæˆå®Œæˆï¼');
    }
    catch (error) {
        console.error('âŒ é”™è¯¯:', error instanceof Error ? error.message : error);
        process.exit(1);
    }
}
// ç›´æ¥è¿è¡Œä¸»å‡½æ•°
main();
